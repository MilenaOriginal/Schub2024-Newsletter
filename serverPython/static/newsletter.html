<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Resúmenes e Imágenes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar bg-dark border-bottom border-body">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="color: aliceblue;">
                NewsLetter
            </a>
        </div>
    </nav>

    <div class="container" style="margin-top: 5%;">
        <div class="card" style="max-width: 800px; margin: auto;">
            <div class="card-body">
                <h5 class="card-title">Generador de Resúmenes e Imágenes</h5>
                <hr>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <div id="cardContainer">
                    <!-- Las tarjetas se mostrarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAX_RETRIES = 15;
        let estrucPred = true;
        let cardHtml;

        // Función para realizar la solicitud con reintentos
        async function retryFunction(fn, retries = MAX_RETRIES) {
            let attempt = 0;
            while (attempt < retries) {
                try {
                    return await fn();
                } catch (error) {
                    attempt++;
                    if (attempt >= retries) {
                        throw new Error(`Error después de ${retries} intentos: ${error.message}`);
                    }
                }
            }
        }

        // Función para obtener el JSON desde una URL
        async function fetchJsonFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Error al cargar el archivo JSON desde la URL');
                }
                const json = await response.json();
                return json;
            } catch (error) {
                throw new Error('Error al procesar el archivo JSON: ' + error.message);
            }
        }

        // Función para generar el resumen largo
        async function generateSummary(text) {
            return retryFunction(async () => {
                updateProgress(25); // Actualizamos el progreso al 25%
                const response = await fetch("https://api-inference.huggingface.co/models/sshleifer/distilbart-cnn-12-6", {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ inputs: text })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error generating summary: ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                updateProgress(50); // Actualizamos el progreso al 50%
                return result[0] ? result[0].summary_text : 'No se pudo generar el resumen.';
            });
        }

        // Función para generar el resumen corto
        async function generateShortSummary(text) {
            return retryFunction(async () => {
                const response = await fetch("https://api-inference.huggingface.co/models/sshleifer/distilbart-cnn-12-6", {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ inputs: text })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error generating short summary: ${response.statusText} - ${errorText}`);
                }

                const result = await response.json();
                updateProgress(75); // Actualizamos el progreso al 75%
                return result[0] ? result[0].summary_text : 'No se pudo generar el resumen corto.';
            });
        }

        // Función para generar la imagen
        async function generateImage(description) {
            return retryFunction(async () => {
                const response = await fetch("https://api-inference.huggingface.co/models/XLabs-AI/flux-RealismLora", {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ inputs: description })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error generating image: ${response.statusText} - ${errorText}`);
                }

                const imageBlob = await response.blob();
                updateProgress(100); // Actualizamos el progreso al 100%
                return URL.createObjectURL(imageBlob);
            });
        }

        // Función para crear la tarjeta
        function createCard(imageUrl, title, shortSummary, longSummary) {
            if (estrucPred == true) {
                cardHtml = `
                <div class="card mb-3" style="max-width: 800px;">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="${imageUrl}" class="card-img-top" alt="Imagen Generada">
                    </div>
                    <div class="col-md-8">
                    <div class="card-body">
                        <p class="card-text">${longSummary}</p>
                    </div>
                    </div>
                </div>
                </div>
                `;
            } else {
                cardHtml = `
                <div class="card mb-3" style="max-width: 800px;">
                    <div class="row g-0">
                        <div class="col-md-8">
                            <div class="card-body">
                                <p class="card-text">${longSummary}</p>
                            </div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <img src="${imageUrl}" class="card-img" alt="Imagen Generada">
                        </div>
                    </div>
                </div>
                `;
            }

            const cardContainer = document.getElementById('cardContainer');
            cardContainer.innerHTML += cardHtml;
        }

        // Función para actualizar el progreso
        function updateProgress(percentage) {
            const progressBar = document.querySelector('.progress-bar');
            const progressContainer = document.querySelector('.progress');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressContainer.style.display = 'block';
        }

        // Función para procesar el archivo
        async function processFile() {
            const filePath = '/static/articles_info.json'; // Ruta del archivo JSON en el servidor

            try {
                const json = await fetchJsonFromUrl(filePath);
                if (!Array.isArray(json) || json.length === 0 || !json[0].text) {
                    throw new Error('Archivo JSON mal formado');
                }

                // Recorremos cada artículo y generamos su tarjeta
                for (let i = 0; i < json.length; i++) {
                    const text = json[i].text;
                    const title = json[i].title || `Artículo ${i + 1}`;
                    const longSummary = await generateSummary(text);
                    const shortSummary = await generateShortSummary(text);
                    const imageUrl = await generateImage(shortSummary);

                    createCard(imageUrl, title, shortSummary, longSummary);

                    // Alternar la estructura predeterminada
                    estrucPred = !estrucPred;
                }
            } catch (error) {
                document.getElementById('cardContainer').innerHTML = 'Error: ' + error.message;
            }
        }

        // Ejecutar la función para procesar el archivo JSON al cargar la página
        window.onload = processFile;

    </script>
</body>
</html>
